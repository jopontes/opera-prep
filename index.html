import React, { useState, useEffect, useRef } from 'react';
import { 
  Music, 
  Brain, 
  Eye, 
  Play, 
  ChevronRight, 
  ChevronLeft, 
  Volume2,
  Layout,
  Clock,
  MapPin,
  Info,
  Youtube,
  X,
  BookOpen,
  RotateCw,
  CheckCircle,
  AlertCircle,
  VolumeX
} from 'lucide-react';

// --- AUDIO ENGINE (Synthesizer for Rossini Crescendo) ---
const playCrescendoSound = (level) => {
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  if (!AudioContext) return;
  
  const ctx = new AudioContext();
  const now = ctx.currentTime;
  const duration = 1.5; // Short burst

  const createOsc = (type, freq, gainVal, delay = 0) => {
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, now);
    
    // Envelope
    gain.gain.setValueAtTime(0, now);
    gain.gain.linearRampToValueAtTime(gainVal, now + 0.1 + delay);
    gain.gain.exponentialRampToValueAtTime(0.001, now + duration);

    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start(now + delay);
    osc.stop(now + duration);
  };

  // Base Chord (C Major)
  const notes = [261.63, 329.63, 392.00, 523.25]; // C4, E4, G4, C5

  if (level >= 1) {
    // Level 1: Soft Sine (Violins pp)
    createOsc('sine', notes[0], 0.1);
    createOsc('sine', notes[2], 0.1);
  }
  if (level >= 2) {
    // Level 2: Triangle (Winds mf) - Adds texture
    createOsc('triangle', notes[1], 0.2, 0.1);
    createOsc('triangle', notes[3], 0.2, 0.1);
  }
  if (level >= 3) {
    // Level 3: Sawtooth (Brass f) - Adds bite
    createOsc('sawtooth', notes[0]/2, 0.3, 0.2); // Low bass
    createOsc('sawtooth', notes[2], 0.2, 0.05);
  }
  if (level >= 4) {
    // Level 4: Square + Noise simulation (Tutti ff)
    createOsc('square', notes[0], 0.4);
    createOsc('square', notes[1], 0.4);
    createOsc('square', notes[2], 0.4);
    createOsc('square', notes[3], 0.4);
    // Simulation of cymbal crash using high freq
    createOsc('sawtooth', 3000, 0.1, 0); 
    createOsc('sawtooth', 4000, 0.1, 0.05); 
  }
};

// --- DATA & CONTENT ---

const MOZART_DATA = {
  title: "Die Zauberfl√∂te",
  composer: "W.A. Mozart",
  image: "https://upload.wikimedia.org/wikipedia/commons/1/1e/Wolfgang-amadeus-mozart_1.jpg",
  video: "https://www.youtube.com/embed/YuBeBjqKSNQ", 
  videoTitle: "Der H√∂lle Rache (Rainha da Noite)",
  synopsis: "O pr√≠ncipe Tamino √© salvo de uma serpente e recebe uma foto de Pamina. Apaixonado, ele parte para resgat√°-la do 'malvado' Sarastro. Ao chegar ao templo, descobre que Sarastro √© s√°bio e a Rainha √© vil√£. Tamino e Pamina passam por provas de inicia√ß√£o (Sil√™ncio, Fogo, √Ågua) para alcan√ßar a ilumina√ß√£o.",
  theme: "bg-indigo-50 text-indigo-950",
  sections: [
    {
      id: "rule_of_three",
      title: "A Regra dos Tr√™s",
      description: "O n√∫mero 3 √© sagrado na Ma√ßonaria e estrutura toda a m√∫sica.",
      items: [
        { label: "3 Acordes", detail: "Abertura: Mib Maior (Trindade)", icon: "üéº" },
        { label: "3 Damas", detail: "Servas da Rainha (Instinto)", icon: "üë©‚Äçüé§" },
        { label: "3 G√™nios", detail: "Guias de Tamino (Esp√≠rito)", icon: "üëº" },
        { label: "3 Provas", detail: "Sil√™ncio, Fogo e √Ågua", icon: "üî•" }
      ]
    },
    {
      id: "duality",
      title: "Noite vs. Sol",
      description: "A √≥pera √© uma batalha entre dois mundos.",
      nodes: [
        { name: "Rainha da Noite", role: "Trevas / Supersti√ß√£o", color: "bg-purple-200 text-purple-900 border-purple-300" },
        { name: "Tamino & Pamina", role: "Humanidade (Em evolu√ß√£o)", color: "bg-gradient-to-r from-purple-100 to-yellow-100 text-gray-900 border-gray-300" },
        { name: "Sarastro", role: "Luz / Raz√£o / Sabedoria", color: "bg-yellow-100 text-yellow-900 border-yellow-300" }
      ]
    }
  ]
};

const ROSSINI_DATA = {
  title: "La cambiale di matrimonio",
  composer: "Gioachino Rossini",
  image: "https://upload.wikimedia.org/wikipedia/commons/e/ec/Gioacchino_Rossini_retouched.jpg",
  video: "https://www.youtube.com/embed/2bYLjGTCbcw", 
  videoTitle: "Destaques da √ìpera",
  synopsis: "Uma farsa c√¥mica sobre neg√≥cios. O ingl√™s Tobia Mill tenta vender sua filha Fanni para o canadense Slook atrav√©s de uma 'Cambiale' (nota promiss√≥ria). Slook, ao ver que Fanni ama o pobre Edoardo, desiste do neg√≥cio e cede o contrato para o jovem casal, enganando o ganancioso pai.",
  theme: "bg-rose-50 text-rose-950",
  sections: [
    {
      id: "crescendo",
      title: "Crescendo Rossiniano",
      description: "Toque no bot√£o para ouvir e ver a 'assinatura' de Rossini.",
      interactive: "crescendo"
    },
    {
      id: "business_flow",
      title: "O Contrato (Trama)",
      description: "Entenda a transa√ß√£o comercial da pe√ßa.",
      flow: [
        { from: "Slook üá®üá¶", action: "Envia Carta", to: "Mill üá¨üáß", detail: "Encomenda uma esposa pelo correio." },
        { from: "Mill", action: "Oferta Fanni", to: "Slook", detail: "Trata a filha como mercadoria." },
        { from: "Slook", action: "Gira a Cambiale", to: "Edoardo", detail: "Transfere o 'produto' para o verdadeiro amor." }
      ]
    }
  ]
};

const HISTORY_DATA = {
  timeline: [
    {
      period: "Barocco (1600-1750)",
      color: "bg-orange-100 text-orange-900 border-orange-200",
      musicalContext: "Basso continuo, ornamentazione improvvisata, nascita dell'opera.",
      plotContext: "Mitologia greca, dei, eroi.",
      composers: [
        { name: "Claudio Monteverdi", img: "https://upload.wikimedia.org/wikipedia/commons/2/23/Claudio_Monteverdi.jpg", work: "L'Orfeo (1607)", detail: "Prima grande opera." },
        { name: "G.F. H√§ndel", img: "https://upload.wikimedia.org/wikipedia/commons/2/22/Haendel.jpg", work: "Giulio Cesare", detail: "Opera Seria, arie Da Capo." }
      ]
    },
    {
      period: "Classicismo (1750-1810)",
      color: "bg-blue-100 text-blue-900 border-blue-200",
      musicalContext: "Equilibrio, chiarezza formale. Riforma di Gluck.",
      plotContext: "Drammi umani, commedie, illuminismo.",
      composers: [
        { name: "W.A. Mozart", img: "https://upload.wikimedia.org/wikipedia/commons/1/1e/Wolfgang-amadeus-mozart_1.jpg", work: "Don Giovanni, Flauta M√°gica", detail: "Perfezione formale." },
        { name: "C.W. Gluck", img: "https://upload.wikimedia.org/wikipedia/commons/1/10/Gluck_Duplessis.jpg", work: "Orfeo ed Euridice", detail: "Nobile semplicit√†." }
      ]
    },
    {
      period: "Bel Canto (1810-1840)",
      color: "bg-pink-100 text-pink-900 border-pink-200",
      musicalContext: "Agilit√†, coloratura, legato, melodia lunga.",
      plotContext: "Passioni romantiche, scene di follia.",
      composers: [
        { name: "Gioachino Rossini", img: "https://upload.wikimedia.org/wikipedia/commons/e/ec/Gioacchino_Rossini_retouched.jpg", work: "Il Barbiere di Siviglia", detail: "Comicit√† e ritmo." },
        { name: "Vincenzo Bellini", img: "https://upload.wikimedia.org/wikipedia/commons/e/ef/Vincenzo_Bellini.jpg", work: "Norma", detail: "Melodie pure." },
        { name: "Gaetano Donizetti", img: "https://upload.wikimedia.org/wikipedia/commons/6/6bd/Gaetano_Donizetti.jpg", work: "Lucia di Lammermoor", detail: "Drammaticit√† e velocit√†." }
      ]
    },
    {
      period: "Romanticismo Verdi (1840-1890)",
      color: "bg-green-100 text-green-900 border-green-200",
      musicalContext: "Dramma musicale, parola scenica.",
      plotContext: "Nazionalismo (Risorgimento), conflitti padre/figlia.",
      composers: [
        { name: "Giuseppe Verdi", img: "https://upload.wikimedia.org/wikipedia/commons/7/70/Giuseppe_Verdi_by_Giovanni_Boldini.jpg", work: "La Traviata, Rigoletto", detail: "Il gigante dell'opera italiana." }
      ]
    },
    {
      period: "Verismo (1890-1920)",
      color: "bg-red-100 text-red-900 border-red-200",
      musicalContext: "Canto declamato, flusso continuo.",
      plotContext: "Gente comune, povert√†, crimini passionali.",
      composers: [
        { name: "Giacomo Puccini", img: "https://upload.wikimedia.org/wikipedia/commons/3/3b/Giacomo_Puccini_01.jpg", work: "La Boh√®me, Tosca", detail: "Emozione diretta." },
        { name: "Pietro Mascagni", img: "https://upload.wikimedia.org/wikipedia/commons/a/ae/Mascagni.jpg", work: "Cavalleria Rusticana", detail: "Inizio del Verismo." },
        { name: "R. Leoncavallo", img: "https://upload.wikimedia.org/wikipedia/commons/d/d6/Ruggero_Leoncavallo_1906.jpg", work: "Pagliacci", detail: "Teatro nel teatro." }
      ]
    }
  ]
};

const FLASHCARDS = [
  // --- TEORIA MUSICALE ---
  { front: "Intervallo Do - Mib", back: "Terza Minore", type: "Teoria", explanation: "1 tono e mezzo. Suono triste." },
  { front: "Intervallo Do - Mi", back: "Terza Maggiore", type: "Teoria", explanation: "2 toni. Suono allegro/stabile." },
  { front: "Tonalit√† con 1 Bemolle (Sib)", back: "Fa Maggiore / Re Minore", type: "Teoria", explanation: "Armatura di chiave fondamentale." },
  { front: "Tonalit√† con Nessuna Alterazione", back: "Do Maggiore / La Minore", type: "Teoria", explanation: "La base del sistema tonale." },
  { front: "Agogica", back: "La velocit√† del brano", type: "Terminologia", explanation: "Es: Allegro, Adagio, Andante." },
  { front: "Sincope", back: "Spostamento dell'accento", type: "Ritmo", explanation: "Accento spostato dal tempo forte al tempo debole." },
  
  // --- STORIA & OPERA ---
  { front: "Prima Opera della Storia", back: "Euridice (Jacopo Peri, 1600)", type: "Storia", explanation: "Anche se l'Orfeo di Monteverdi √® la prima 'famosa', Peri arriv√≤ prima." },
  { front: "Riforma di Gluck", back: "Nobile Semplicit√†", type: "Storia", explanation: "Meno virtuosismi inutili, pi√π dramma." },
  { front: "Anno morte Mozart", back: "1791", type: "Storia", explanation: "Stesso anno de La Flauta M√°gica." },
  { front: "Trilogia Popolare Verdi", back: "Rigoletto, Trovatore, Traviata", type: "Storia", explanation: "Le opere che lo resero famoso nel mondo." },
  { front: "Verso Endecasillabo", back: "Accento sulla 10¬™ sillaba", type: "Metrica", explanation: "Il verso principale dell'opera seria." },
  { front: "Parola Tronca", back: "Accento sull'ultima sillaba", type: "Metrica", explanation: "Si conta fino all'ultima + 1." },
  
  // --- SICUREZZA (D.Lgs 81/08) ---
  { front: "RSPP", back: "Responsabile del Servizio di Prevenzione e Protezione", type: "Sicurezza", explanation: "Figura tecnica obbligatoria." },
  { front: "DPI", back: "Dispositivi di Protezione Individuale", type: "Sicurezza", explanation: "Casco, scarpe antinfortunistiche, tappi per orecchie." },
  { front: "RLS", back: "Rappresentante dei Lavoratori per la Sicurezza", type: "Sicurezza", explanation: "Eletto dai lavoratori per dialogare sulla sicurezza." },
  { front: "Preposto", back: "Sovrintende all'attivit√† lavorativa", type: "Sicurezza", explanation: "Garantisce che si seguano le regole (es: capo scena)." },
  { front: "Cartello Verde", back: "Uscita di Emergenza / Salvataggio", type: "Sicurezza", explanation: "Indica la via di fuga." },
  { front: "Cartello Rosso", back: "Antincendio / Divieto", type: "Sicurezza", explanation: "Indica estintori o azioni vietate." }
];

// --- COMPONENTS ---

// Image Component with Fallback
const SafeImage = ({ src, alt, className }) => {
  const [error, setError] = useState(false);
  
  if (error) {
    return (
      <div className={`${className} bg-stone-200 flex items-center justify-center border-2 border-stone-300`}>
        <Music className="w-1/3 h-1/3 text-stone-400 opacity-50" />
      </div>
    );
  }

  return (
    <img 
      src={src} 
      alt={alt} 
      className={className} 
      onError={() => setError(true)} 
    />
  );
};

const ReadingMask = ({ active, mouseY }) => {
  if (!active) return null;
  return (
    <>
      <div className="fixed top-0 left-0 w-full bg-white/95 pointer-events-none z-50 transition-all duration-75" style={{ height: mouseY - 70 }} />
      <div className="fixed bottom-0 left-0 w-full bg-white/95 pointer-events-none z-50 transition-all duration-75" style={{ top: mouseY + 70 }} />
      <div className="fixed left-0 w-full h-[140px] pointer-events-none z-50 border-y-4 border-amber-500/50 mix-blend-multiply" style={{ top: mouseY - 70 }} />
    </>
  );
};

const VideoModal = ({ url, title, onClose }) => (
  <div className="fixed inset-0 z-[60] bg-black/90 backdrop-blur-md flex items-center justify-center p-4 animate-in fade-in duration-300">
    <div className="w-full max-w-lg bg-white rounded-3xl overflow-hidden shadow-2xl">
      <div className="p-4 flex justify-between items-center bg-stone-100 border-b border-stone-200">
        <h3 className="text-stone-900 font-bold truncate pr-4">{title}</h3>
        <button onClick={onClose} className="text-stone-500 hover:text-red-600 p-2 bg-white rounded-full shadow-sm border border-stone-200 transition-colors">
          <X className="w-6 h-6" />
        </button>
      </div>
      <div className="relative pt-[56.25%] bg-black">
        <iframe 
          className="absolute top-0 left-0 w-full h-full"
          src={url} 
          title="YouTube video player" 
          frameBorder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
          allowFullScreen
        ></iframe>
      </div>
    </div>
  </div>
);

const Header = ({ setView, settings, toggleSetting }) => (
  <header className="px-6 py-4 shadow-sm flex justify-between items-center sticky top-0 z-40 bg-[#faf8f4] border-b-2 border-stone-200 text-stone-900">
    <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('dashboard')}>
      <div className="bg-rose-500 p-2 rounded-xl shadow-md text-white border-2 border-rose-600">
        <Music className="w-6 h-6" />
      </div>
      <div>
        <span className="font-black text-xl tracking-tight text-stone-800 block leading-none">OperaFlow</span>
        <span className="text-[10px] font-bold uppercase tracking-widest text-stone-500">Bologna Prep</span>
      </div>
    </div>
    
    <div className="flex gap-2">
      <button 
        onClick={() => toggleSetting('mask')} 
        className={`p-3 rounded-xl transition-all border-2 font-bold flex items-center gap-2 ${settings.mask ? 'bg-indigo-600 border-indigo-700 text-white shadow-inner' : 'bg-white border-stone-300 text-stone-500 shadow-sm'}`} 
        title="M√°scara de Leitura"
      >
        <Eye className="w-5 h-5" />
      </button>
    </div>
  </header>
);

const ModuleCard = ({ title, subtitle, icon, color, image, onClick }) => (
  <div onClick={onClick} className="group relative w-full h-44 rounded-[2rem] overflow-hidden cursor-pointer shadow-md hover:shadow-xl active:scale-95 transition-all duration-300 mb-5 border-4 border-white ring-1 ring-stone-200">
    <div className="absolute inset-0 bg-stone-200">
      <SafeImage src={image} alt={title} className="w-full h-full object-cover opacity-100 group-hover:scale-105 transition-transform duration-700" />
      <div className={`absolute inset-0 bg-gradient-to-r ${color} opacity-90 mix-blend-multiply`} />
      <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent" />
    </div>
    <div className="relative z-10 h-full p-6 flex flex-col justify-end">
      <div className="flex items-center gap-3 mb-1">
         <span className="text-2xl bg-white/20 p-2 rounded-xl backdrop-blur-md shadow-sm border border-white/30">{icon}</span>
         <span className="text-white font-bold text-xs uppercase tracking-widest bg-black/30 px-2 py-1 rounded-lg backdrop-blur-sm border border-white/10">{subtitle}</span>
      </div>
      <h3 className="text-3xl font-black text-white leading-none drop-shadow-lg">{title}</h3>
    </div>
  </div>
);

// --- INTERACTIVE CRESCENDO (AUDIO + VISUAL) ---
const CrescendoInteractive = () => {
  const [level, setLevel] = useState(0);
  
  const steps = [
    { label: "1. Inizio", desc: "Violini (pp) - Sussurro", color: "bg-green-100 text-green-900 border-green-400", size: "w-24 h-24", icon: <VolumeX className="w-6 h-6"/> },
    { label: "2. Aggiunta", desc: "Fiati (mf) - Texture", color: "bg-yellow-100 text-yellow-900 border-yellow-400", size: "w-32 h-32", icon: <Volume2 className="w-6 h-6"/> },
    { label: "3. Tensione", desc: "Ottoni (f) - Forza", color: "bg-orange-100 text-orange-900 border-orange-400", size: "w-40 h-40", icon: <Volume2 className="w-8 h-8"/> },
    { label: "4. Esplosione!", desc: "TUTTI (ff) - Caos!", color: "bg-red-100 text-red-900 border-red-500 animate-pulse", size: "w-48 h-48", icon: <Volume2 className="w-10 h-10"/> }
  ];

  const handleClick = () => {
    const nextLevel = (level + 1) % steps.length;
    setLevel(nextLevel);
    // Play sound for the NEW level (if level 0, silence or restart logic, here we treat 0 as start again)
    if (nextLevel > 0) playCrescendoSound(nextLevel);
  };

  return (
    <div className="bg-white p-6 rounded-[2rem] text-center shadow-sm border-2 border-stone-200">
       <div className="h-64 flex items-center justify-center relative mb-4 bg-stone-50 rounded-2xl border border-stone-100 overflow-hidden">
         <div className="absolute inset-0 opacity-10" style={{ backgroundImage: 'radial-gradient(circle, #000 1px, transparent 1px)', backgroundSize: '20px 20px' }}></div>
         
         {/* Visual Pulse Rings */}
         {level > 0 && <div className={`absolute rounded-full border-4 ${level === 3 ? 'border-red-400' : 'border-stone-300'} w-56 h-56 animate-ping opacity-30`} key={level} />}
         
         <button 
           onClick={handleClick}
           className={`rounded-full flex flex-col items-center justify-center shadow-xl transition-all duration-300 z-10 border-[6px] ${steps[level].color} ${steps[level].size} hover:scale-105 active:scale-95`}
         >
           {steps[level].icon}
           <span className="text-[10px] font-black uppercase tracking-widest opacity-60 mt-1">Clicca</span>
         </button>
       </div>
       
       <div className={`rounded-xl p-4 transition-all border-2 ${level === 3 ? 'bg-red-50 border-red-200' : 'bg-stone-50 border-stone-200'}`}>
         <div className="font-black text-2xl mb-1 text-stone-800">{steps[level].label}</div>
         <div className="text-stone-600 font-bold">{steps[level].desc}</div>
       </div>
    </div>
  );
};

const DetailView = ({ data, onBack, children }) => {
  const [showVideo, setShowVideo] = useState(false);

  return (
    <div className="min-h-screen pb-12 bg-[#faf8f4] text-stone-800 transition-colors">
      {showVideo && <VideoModal url={data.video} title={data.videoTitle} onClose={() => setShowVideo(false)} />}
      
      {/* Hero Image Header */}
      <div className="relative h-80 w-full rounded-b-[3rem] overflow-hidden shadow-md border-b-4 border-white">
        <div className="absolute top-4 left-4 z-20">
          <button onClick={onBack} className="bg-white hover:bg-stone-100 text-stone-900 px-5 py-2.5 rounded-full flex items-center gap-2 text-sm font-bold transition-all shadow-lg border border-stone-200">
            <ChevronLeft className="w-5 h-5" /> Voltar
          </button>
        </div>
        <SafeImage src={data.image} alt={data.composer} className="w-full h-full object-cover object-top" />
        <div className="absolute inset-0 bg-gradient-to-t from-[#faf8f4] via-transparent to-transparent opacity-100" />
        
        <div className="absolute bottom-0 left-0 w-full p-8 text-center">
          <p className="text-xs font-black uppercase tracking-[0.2em] text-stone-500 mb-2 flex items-center justify-center gap-2 bg-white/50 py-1 px-3 rounded-full w-fit mx-auto backdrop-blur-sm border border-stone-200">
            <Music className="w-3 h-3"/> {data.composer}
          </p>
          <h1 className="text-4xl sm:text-5xl font-black text-stone-900 mb-6 leading-tight drop-shadow-sm">{data.title}</h1>
          
          {data.video && (
            <button 
              onClick={() => setShowVideo(true)}
              className="inline-flex items-center gap-2 bg-rose-600 hover:bg-rose-700 text-white px-8 py-4 rounded-2xl font-bold text-sm shadow-xl shadow-rose-200 transition-transform active:scale-95 border-2 border-rose-700"
            >
              <Youtube className="w-5 h-5" />
              Ver √Åria Principal
            </button>
          )}
        </div>
      </div>

      <div className="p-6 max-w-2xl mx-auto space-y-8 animate-in slide-in-from-bottom-4 duration-500">
        {/* Sinopse Box */}
        {data.synopsis && (
           <div className="bg-white p-6 rounded-[2rem] border-2 border-stone-200 shadow-sm relative overflow-hidden">
             <div className="absolute top-0 left-0 w-3 h-full bg-amber-400" />
             <h3 className="font-bold flex items-center gap-2 mb-3 text-xs uppercase tracking-widest text-amber-700">
               <BookOpen className="w-4 h-4"/> Sinopse Express
             </h3>
             <p className="text-stone-700 leading-relaxed font-semibold text-lg">{data.synopsis}</p>
           </div>
        )}
        
        {children}
      </div>
    </div>
  );
};

// --- VIEWS ---

const Dashboard = ({ setView }) => (
  <div className="p-6 max-w-md mx-auto animate-in fade-in duration-500 pb-24">
    <div className="mb-8 text-center bg-white p-6 rounded-[2rem] border-2 border-stone-100 shadow-sm">
      <h2 className="text-3xl font-black text-stone-800 mb-2">Bologna Prep</h2>
      <p className="text-stone-500 font-bold uppercase tracking-wide text-sm">Guia de Estudo Visual</p>
    </div>
    
    <div className="flex flex-col gap-4">
      <ModuleCard 
        title="Storia dell'Opera" 
        subtitle="Cronologia" 
        icon="üìú" 
        color="from-amber-200 to-amber-100" 
        image="https://upload.wikimedia.org/wikipedia/commons/2/23/Claudio_Monteverdi.jpg"
        onClick={() => setView('history')}
      />
      <ModuleCard 
        title="Mozart" 
        subtitle="Die Zauberfl√∂te" 
        icon="üé≠" 
        color="from-indigo-200 to-indigo-100" 
        image={MOZART_DATA.image}
        onClick={() => setView('mozart')}
      />
      <ModuleCard 
        title="Rossini" 
        subtitle="La Cambiale" 
        icon="‚ö°" 
        color="from-rose-200 to-rose-100" 
        image={ROSSINI_DATA.image}
        onClick={() => setView('rossini')}
      />
      <ModuleCard 
        title="Flashcards" 
        subtitle="Teoria & Sicurezza" 
        icon="üß†" 
        color="from-emerald-200 to-emerald-100" 
        image="https://upload.wikimedia.org/wikipedia/commons/7/70/Giuseppe_Verdi_by_Giovanni_Boldini.jpg"
        onClick={() => setView('theory')}
      />
    </div>
  </div>
);

const HistoryView = ({ onBack }) => (
  <div className="min-h-screen bg-[#faf8f4] text-stone-800">
    <div className="sticky top-0 z-30 bg-white/95 backdrop-blur p-4 shadow-sm border-b border-stone-200 flex items-center gap-3">
      <button onClick={onBack} className="p-2 hover:bg-stone-100 rounded-full border border-stone-200"><ChevronLeft /></button>
      <h2 className="text-lg font-black text-stone-800">Cronologia da √ìpera</h2>
    </div>
    
    <div className="p-6 max-w-md mx-auto space-y-12 pb-24">
      {HISTORY_DATA.timeline.map((era, i) => (
        <div key={i} className={`relative pl-8 border-l-[6px] ${era.color.split(' ')[2]}`}>
          <div className="absolute left-[-13px] top-0 w-6 h-6 rounded-full bg-white border-[6px] border-stone-300 shadow-sm z-10" />
          
          <div className="mb-8">
            <span className={`text-xs font-black uppercase tracking-widest px-4 py-2 rounded-lg inline-block mb-4 border-2 ${era.color}`}>
              {era.period}
            </span>
            
            {/* Info Cards */}
            <div className="bg-white p-5 rounded-[1.5rem] mb-6 text-sm shadow-sm border-2 border-stone-100">
              <p className="mb-3 border-b border-stone-100 pb-2"><strong className="text-stone-900 block mb-1 uppercase text-xs tracking-wider">üéµ Contexto Musical</strong> {era.musicalContext}</p>
              <p><strong className="text-stone-900 block mb-1 uppercase text-xs tracking-wider">üé≠ Enredos & Temas</strong> {era.plotContext}</p>
            </div>
            
            {/* Composers */}
            <div className="space-y-4">
              {era.composers.map((comp, j) => (
                <div key={j} className="flex items-start gap-4 p-4 rounded-[1.5rem] bg-white border-2 border-stone-100 shadow-sm hover:shadow-md transition-all">
                  <SafeImage src={comp.img} alt={comp.name} className="w-16 h-16 rounded-full object-cover border-4 border-stone-100 shadow-sm shrink-0 bg-stone-200" />
                  <div>
                    <h4 className="font-black text-lg text-stone-800 leading-tight">{comp.name}</h4>
                    <p className="text-[10px] font-bold uppercase text-stone-400 mb-1">{comp.work}</p>
                    <p className="text-xs text-stone-600 leading-relaxed font-medium bg-stone-50 p-2 rounded-lg border border-stone-100">{comp.detail}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>
);

const TheoryView = ({ onBack }) => {
  const [index, setIndex] = useState(0);
  const [flipped, setFlipped] = useState(false);
  const card = FLASHCARDS[index];

  const next = () => { setFlipped(false); setTimeout(() => setIndex((i) => (i + 1) % FLASHCARDS.length), 200); };
  const prev = () => { setFlipped(false); setTimeout(() => setIndex((i) => i === 0 ? FLASHCARDS.length - 1 : i - 1), 200); };

  return (
    <div className="min-h-screen flex flex-col bg-[#faf8f4]">
      <div className="bg-emerald-100 text-emerald-900 p-4 flex items-center gap-3 border-b-2 border-emerald-200 sticky top-0 z-20">
        <button onClick={onBack} className="p-2 bg-white rounded-full shadow-sm border border-emerald-200"><ChevronLeft className="w-5 h-5"/></button>
        <div>
          <h2 className="font-black text-lg leading-none">Flashcards</h2>
          <span className="text-xs font-bold uppercase opacity-60">Italiano & Teoria</span>
        </div>
      </div>

      <div className="flex-1 flex flex-col items-center p-6 pb-24">
        
        <div className="w-full max-w-sm flex-1 flex flex-col justify-center my-4">
            {/* Flashcard Area */}
            <div 
              onClick={() => setFlipped(!flipped)} 
              className="relative w-full aspect-[4/5] cursor-pointer group perspective-1000 transition-all duration-300"
            >
              <div className={`w-full h-full rounded-[2.5rem] shadow-xl border-b-[12px] transition-all duration-500 relative bg-white overflow-hidden flex flex-col border-2 ${flipped ? 'border-emerald-600' : 'border-stone-200'}`}>
                 
                 {/* Card Content */}
                 {!flipped ? (
                    <div className="absolute inset-0 flex flex-col items-center justify-center p-8 animate-in fade-in duration-300 bg-white">
                      <span className="text-[10px] font-black uppercase tracking-[0.2em] mb-8 bg-stone-100 px-4 py-2 rounded-full text-stone-500 border border-stone-200">{card.type}</span>
                      <h3 className="text-3xl font-black text-center text-stone-800 leading-tight">{card.front}</h3>
                      <div className="absolute bottom-10 flex items-center gap-2 text-stone-400 text-xs font-bold uppercase tracking-widest animate-pulse">
                         <RotateCw className="w-4 h-4"/> Tocca per girare
                      </div>
                    </div>
                 ) : (
                    <div className="absolute inset-0 flex flex-col p-8 animate-in fade-in duration-300 bg-emerald-50">
                       <div className="flex-1 flex flex-col items-center justify-center text-center">
                          <h3 className="text-2xl font-black mb-6 text-emerald-900">{card.back}</h3>
                          
                          <div className="bg-white p-6 rounded-2xl shadow-sm border border-emerald-100 w-full">
                            <p className="text-sm font-semibold leading-relaxed text-stone-600">
                              <Info className="w-4 h-4 inline mr-2 mb-1 text-emerald-500"/>
                              {card.explanation}
                            </p>
                          </div>
                       </div>
                    </div>
                 )}
              </div>
            </div>
        </div>

        {/* Controls */}
        <div className="flex items-center gap-6 w-full max-w-sm">
           <button onClick={prev} className="p-4 rounded-2xl bg-white border-2 border-stone-200 text-stone-400 hover:text-stone-800 shadow-sm"><ChevronLeft /></button>
           <div className="flex-1 flex justify-center gap-1.5 flex-wrap">
              {FLASHCARDS.map((_, i) => (
                <div key={i} className={`w-2 h-2 rounded-full transition-all ${i === index ? 'bg-emerald-500 scale-125' : 'bg-stone-200'}`} />
              ))}
           </div>
           <button onClick={next} className="p-4 rounded-2xl bg-emerald-500 border-2 border-emerald-600 text-white shadow-lg shadow-emerald-200 hover:scale-105 transition-transform"><ChevronRight /></button>
        </div>
      </div>
    </div>
  );
};

// --- MAIN APP ---

const App = () => {
  const [view, setView] = useState('dashboard');
  const [settings, setSettings] = useState({ mask: false });
  const [mouseY, setMouseY] = useState(0);

  useEffect(() => {
    const handleMove = (e) => setMouseY(e.clientY);
    window.addEventListener('mousemove', handleMove);
    return () => window.removeEventListener('mousemove', handleMove);
  }, []);

  const toggle = (k) => setSettings(p => ({ ...p, [k]: !p[k] }));

  return (
    <div className="font-sans text-stone-800 bg-[#faf8f4] min-h-screen selection:bg-rose-200 selection:text-rose-900">
      <ReadingMask active={settings.mask} mouseY={mouseY} />
      
      {view === 'dashboard' && (
        <>
          <Header setView={setView} settings={settings} toggleSetting={toggle} />
          <Dashboard setView={setView} />
        </>
      )}

      {view === 'history' && <HistoryView onBack={() => setView('dashboard')} />}
      {view === 'theory' && <TheoryView onBack={() => setView('dashboard')} />}

      {view === 'mozart' && (
        <DetailView data={MOZART_DATA} onBack={() => setView('dashboard')}>
          {MOZART_DATA.sections.map((sec, i) => (
            <div key={i} className="bg-white p-6 rounded-[2rem] shadow-sm border-2 border-stone-100 mb-6">
              <h3 className="text-2xl font-black mb-2 text-stone-800">{sec.title}</h3>
              <p className="text-stone-500 mb-6 font-bold text-sm uppercase tracking-wide">{sec.description}</p>
              
              {sec.items && (
                <div className="space-y-3">
                  {sec.items.map((item, j) => (
                    <div key={j} className="flex items-center gap-4 p-4 rounded-2xl bg-indigo-50 border border-indigo-100">
                      <span className="text-2xl bg-white p-2 rounded-xl shadow-sm border border-indigo-50">{item.icon}</span>
                      <div>
                        <p className="font-black text-indigo-900 text-lg">{item.label}</p>
                        <p className="text-sm text-indigo-700 font-medium">{item.detail}</p>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {sec.nodes && (
                <div className="flex flex-col gap-3">
                  {sec.nodes.map((node, j) => (
                    <div key={j} className={`${node.color} border-2 p-5 rounded-2xl text-center shadow-sm`}>
                      <p className="font-black text-xl">{node.name}</p>
                      <p className="text-xs opacity-80 uppercase tracking-widest font-bold mt-1">{node.role}</p>
                    </div>
                  ))}
                </div>
              )}
            </div>
          ))}
        </DetailView>
      )}

      {view === 'rossini' && (
        <DetailView data={ROSSINI_DATA} onBack={() => setView('dashboard')}>
          {ROSSINI_DATA.sections.map((sec, i) => (
            <div key={i} className="bg-white p-6 rounded-[2rem] shadow-sm border-2 border-stone-100 mb-6">
              <h3 className="text-2xl font-black mb-2 text-stone-800">{sec.title}</h3>
              <p className="text-stone-500 mb-6 font-bold text-sm uppercase tracking-wide">{sec.description}</p>

              {sec.interactive === 'crescendo' && (
                <CrescendoInteractive />
              )}

              {sec.flow && (
                <div className="relative border-l-[3px] border-dashed border-rose-200 ml-4 space-y-8 py-4">
                  {sec.flow.map((step, j) => (
                    <div key={j} className="relative pl-8 group">
                      <div className="absolute left-[-11px] top-6 w-5 h-5 bg-rose-400 rounded-full border-4 border-white shadow-sm group-hover:bg-rose-600 transition-colors" />
                      <div className="bg-stone-50 p-5 rounded-2xl border-2 border-stone-100 hover:border-rose-300 transition-colors shadow-sm">
                        <div className="flex justify-between items-center font-black mb-3 text-lg">
                          <span className="text-stone-700">{step.from}</span>
                          <ChevronRight className="text-rose-400 stroke-[3px]"/>
                          <span className="text-stone-700">{step.to}</span>
                        </div>
                        <div className="inline-block px-3 py-1 bg-rose-100 text-rose-900 rounded-lg font-bold uppercase text-[10px] mb-3 tracking-widest border border-rose-200">
                          {step.action}
                        </div>
                        <p className="text-sm text-stone-500 font-medium italic border-t border-stone-200 pt-3">
                          "{step.detail}"
                        </p>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          ))}
        </DetailView>
      )}
    </div>
  );
};

export default App;
